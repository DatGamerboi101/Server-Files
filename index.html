<html>
    <head>
        <title>Protoshock Server Status</title>
        <meta content="Protoshock Server Status" property="og:title" />
        <meta content="Protoshock Server Status" property="og:description" />
        <meta content="#00fffb" data-react-helmet="true" name="theme-color" />
        <link rel="stylesheet" href="/assets/style.css" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
    </head>
    <body>
        <h1 class="nonbs_center">Protoshock Server Status</h1>
        <h1 class="nonbs_center">Graphs</h1>
        <div id="display"><p>Waiting for connection...</p></div>
        <div id="spacer" style="display: block; width: 200px; height: 10em; margin-right:0px;"></div>
        <div class="container">
        <div class="rooms-container">
            <h1 class="nonbs_center">Rooms</h1>
            <div id="room" class='room'><p class="room-text">No rooms</p></div>
        </div>
        <div class="container_data">
            <div class="row">
                <div class="col-md-4">
                    <div class="stat-box">
                        <div id="server-uptime" class="title pos">0s</div>
                        <div class="body">Server Uptime</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box">
                        <div id="player-count" class="title pos">0</div>
                        <div class="body">Player Count</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box">
                        <div id="memory-usage" class="title pos">0mb</div>
                        <div class="body">Global Memory Usage</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-box">
                        <div id="server-ping" class="title pos">0ms</div>
                        <div class="body">Ping</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
        <script>
            const socket = io();
            const displayelement = document.getElementById("display");
            var i = 0;
            var usagehistory = [0, 8000];
            var playerhistory = [0, 5];
            var time = [0,0];
            var ping = 0;
            socket.emit("webmessage");
            socket.on("pong", (timestampdata) =>{
                var d = new Date();
                var currentMilliseconds = d.getMilliseconds();
                ping = currentMilliseconds - timestampdata;
            });
            function formatTime(inputTime) {
  const parts = inputTime.split(' ');

  if (parts.length < 2 || parts.length % 2 !== 0) {
    return 'Invalid time format';
  }

  let duration = {
    y: 0,
    m: 0,
    w: 0,
    d: 0,
    h: 0,
    min: 0,
    mins: 0,
    s: 0,
  };

  for (let i = 0; i < parts.length; i += 2) {
    const value = parseInt(parts[i]);
    const unit = parts[i + 1];

    if (isNaN(value)) {
      return 'Invalid time format';
    }

    switch (unit) {
      case 'years':
      case 'year':
        duration.y = value;
        break;
      case 'months':
      case 'month':
        duration.m = value;
        break;
      case 'weeks':
      case 'week':
        duration.w = value;
        break;
      case 'days':
      case 'day':
        duration.d = value;
        break;
      case 'hours':
      case 'hour':
        duration.h = value;
        break;
      case 'minutes':
        duration.mins = value;
        break;
      case 'minute':
        duration.min = value;
        break;
      case 'seconds':
      case 'second':
        duration.s = value;
        break;
      default:
        return 'Invalid time unit';
    }
  }

  const formattedTime = Object.entries(duration)
    .filter(([unit, value]) => value > 0)
    .map(([unit, value]) => `${value}${unit}`)
    .join(' ');

  return formattedTime;
}


            socket.on('webmessageclient', (data) => {
                var d = new Date();
                var currentMilliseconds = d.getMilliseconds();
                socket.emit("ping", currentMilliseconds);
                const rooms = data.rooms;
                const playercount = data.globalplayercount;
                const Uptime = data.uptime
                const formattedTime = formatTime(Uptime);
                const Usage = data.usage;
                usagehistory.push(Usage);
                playerhistory.push(playercount);
                time.push(i);
                while (usagehistory.length > 25) {
                    usagehistory.shift();
                    playerhistory.shift();
                    time.shift();   
                    usagehistory[0] = 0;
                    playerhistory[0] = 0;
                    usagehistory[1] = 8000;
                    playerhistory[1] = 5;
                }
                var roomtext = "";
                rooms.forEach(room => {
                    roomtext = roomtext 
                    + "<div class='room'><p class='room-text'> Room ID: " + room.RoomID
                    + " | Version: " + room.RoomGameVersion
                    + " | Room Name: " + room.RoomName
                    + " | Player Count: " + room.RoomPlayerCount + "/" + room.RoomPlayerMax
                    + "</p></div>";
                });
                if(rooms.length == 0){
                    roomtext = "<div class='room'><p class='room-text'>No rooms</p></div><br/></div>";
                }

                var pingtext = "";
                if(ping < 50){
                    pingtext = "<p>Ping: <span class='good'>" + ping + "ms</span></p>"
                } 
                else{
                    if(ping > 50 && ping < 100){
                        pingtext = "<p>Ping: <span class='medium'>" + ping + "ms</span></p>"
                    }
                    else{
                        pingtext = "<p>Ping: <span class='bad'>" + ping + "ms</span></p>"
                    }
                }
                
                displayelement.innerHTML = 
                 "<div class='container_graph'><canvas class='graph' id='Memory'></canvas>"
                + "<canvas class='graph2' id='Player Count'></canvas></div>"    ;           
                document.getElementById('room').innerHTML = roomtext;
                document.getElementById('server-ping').innerHTML = pingtext;
                document.getElementById('server-uptime').innerHTML = formattedTime;
                document.getElementById('player-count').innerHTML = playercount;
                document.getElementById('memory-usage').innerHTML = Usage + 'mb';

                new Chart(document.getElementById("Memory"), {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [{ 
                        data: usagehistory,
                        label: "Memory Usage",
                        borderColor: "#00ffff",
                        fill: false
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
        duration: 0
        
    },
                    title: {
                    display: true,
                    text: 'Server Stats'
                    },
                }
                });
                new Chart(document.getElementById("Player Count"), {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [
                    {
                        data: playerhistory,
                        label: "Player count",
                        borderColor: "#ff0000",
                        fill: false
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
        duration: 0
    },
                    title: {
                    display: true,
                    text: 'Server Stats'
                    },
                }
                });

                i++;
            });
// Function to center and resize elements with a 20px margin
function centerAndResizeElements() {
  const margin = 20; // 20px margin from the sides
  const containerWidth = window.innerWidth;
  const graphElements = document.querySelectorAll('.graph, .graph2');

  graphElements.forEach(element => {
    // Calculate the new width, considering the margin
    const newWidth = containerWidth - (2 * margin);

    // Check if the new width is less than the original width
    if (newWidth < element.offsetWidth) {
      element.style.width = '100%'; // Set to 100% if the screen is too small
    } else {
      // Calculate the left margin to center the element
      const marginLeft = (containerWidth - newWidth) / 2 - margin;

      // Apply the margin, centering, and resizing using JavaScript
      element.style.margin = '0 auto';
      element.style.width = `${newWidth}px`;
    }
  });
}

// Call the function when the window is resized and initially
window.addEventListener('load', centerAndResizeElements);
window.addEventListener('resize', centerAndResizeElements);

        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    </body>
</html>